const firebaseConfig={apiKey:"AIzaSyBkMUmD27GU34yIPQAj7KUErt9muB0MdLk",authDomain:"vamora-co-in.firebaseapp.com",projectId:"vamora-co-in",storageBucket:"vamora-co-in.appspot.com",messagingSenderId:"613048727757",appId:"1:613048727757:web:d0c73e84fa7d93a5c21184",measurementId:"G-8R6TDRQGS6"};document.addEventListener('DOMContentLoaded',function(){setupEventListeners();auth.onAuthStateChanged(handleAuthStateChange);});function showOrdersSection(){ordersSection.classList.remove('hidden');submissionsSection.classList.add('hidden');showOrdersBtn.classList.remove('bg-gray-300','text-gray-800');showOrdersBtn.classList.add('bg-black','text-white');showSubmissionsBtn.classList.remove('bg-black','text-white');showSubmissionsBtn.classList.add('bg-gray-300','text-gray-800');}
function showSubmissionsSection(){submissionsSection.classList.remove('hidden');ordersSection.classList.add('hidden');showSubmissionsBtn.classList.remove('bg-gray-300','text-gray-800');showSubmissionsBtn.classList.add('bg-black','text-white');showOrdersBtn.classList.remove('bg-black','text-white');showOrdersBtn.classList.add('bg-gray-300','text-gray-800');}const authError=document.getElementById('authError');const showOrdersBtn=document.getElementById('showOrdersBtn');const showSubmissionsBtn=document.getElementById('showSubmissionsBtn');const ordersSection=document.getElementById('ordersSection');const submissionsSection=document.getElementById('contactSubmissionsSection');const toast=document.getElementById('toast');const ordersTableBody=document.getElementById('ordersTableBody');const searchOrders=document.getElementById('searchOrders');const statusFilter=document.getElementById('statusFilter');const orderDetailsModal=document.getElementById('orderDetailsModal');const submissionsList=document.getElementById('submissionsList');const searchInput=document.getElementById('searchInput');const loadingIndicator=document.getElementById('loadingIndicator');const noResults=document.getElementById('noResults');const errorContainer=document.getElementById('errorContainer');const prevPage=document.getElementById('prevPage');const nextPage=document.getElementById('nextPage');const prevPageMobile=document.getElementById('prevPageMobile');const nextPageMobile=document.getElementById('nextPageMobile');const pageNumbers=document.getElementById('pageNumbers');const paginationInfo=document.getElementById('paginationInfo');const closeOrderDetailsBtn=document.getElementById('closeOrderDetails');const updateStatusBtn=document.getElementById('updateStatusBtn');const cancelOrderBtn=document.getElementById('cancelOrderBtn');const deleteOrderBtn=document.getElementById('deleteOrderBtn');let currentPage=1;const ordersPerPage=10;let totalOrders=0;let allOrders=[];let filteredOrders=[];let currentOrderId=null;firebase.initializeApp(firebaseConfig);const auth=firebase.auth();const db=firebase.firestore();const provider=new firebase.auth.GoogleAuthProvider();const ADMIN_EMAIL='vamora.co.in@gmail.com';const loadingState=document.getElementById('loadingState');const unauthorizedState=document.getElementById('unauthorizedState');const adminDashboard=document.getElementById('adminDashboard');const adminLoginBtn=document.getElementById('adminLoginBtn');const logoutBtn=document.getElementById('logoutBtn');function setupEventListeners(){if(adminLoginBtn)adminLoginBtn.addEventListener('click',handleAdminLogin);if(logoutBtn)logoutBtn.addEventListener('click',handleLogout);if(showOrdersBtn)showOrdersBtn.addEventListener('click',showOrdersSection);if(showSubmissionsBtn)showSubmissionsBtn.addEventListener('click',showSubmissionsSection);if(searchOrders)searchOrders.addEventListener('input',filterOrders);if(statusFilter)statusFilter.addEventListener('change',filterOrders);if(closeOrderDetailsBtn)closeOrderDetailsBtn.addEventListener('click',()=>orderDetailsModal.classList.add('hidden'));if(updateStatusBtn)updateStatusBtn.addEventListener('click',updateOrderStatus);if(cancelOrderBtn)cancelOrderBtn.addEventListener('click',cancelOrder);if(deleteOrderBtn)deleteOrderBtn.addEventListener('click',deleteOrder);window.addEventListener('click',(event)=>{if(event.target===orderDetailsModal){orderDetailsModal.classList.add('hidden');}});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&!orderDetailsModal.classList.contains('hidden')){orderDetailsModal.classList.add('hidden');}});document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');loadSubmissions(btn.dataset.filter);});});if(searchInput)searchInput.addEventListener('input',filterSubmissions);if(submissionsList){submissionsList.addEventListener('click',async(e)=>{const target=e.target.closest('.mark-read, .delete');if(!target)return;const id=target.dataset.id;const card=target.closest('.submission-card');try{target.style.transform='scale(0.95)';setTimeout(()=>{target.style.transform='';},200);if(target.classList.contains('mark-read')){await db.collection('contactSubmissions').doc(id).update({status:'read'});card.querySelector('.status-badge-contact').className='status-badge-contact status-read';card.querySelector('.status-badge-contact').textContent='read';target.remove();}else if(target.classList.contains('delete')){if(confirm('Are you sure you want to delete this submission?')){await db.collection('contactSubmissions').doc(id).delete();card.style.opacity='0';setTimeout(()=>card.remove(),300);}}const activeFilter=document.querySelector('.filter-btn.active').dataset.filter;if(activeFilter!=='all'){if(target.classList.contains('delete')){}else if(activeFilter!=='read'&&target.classList.contains('mark-read')){card.style.display='none';}}}catch(error){if(error.code==='permission-denied'){showError("You don't have permission to perform this action");}else{showError(`Operation failed: ${error.message}`);}}});}}function handleAuthStateChange(user){if(user){if(user.email===ADMIN_EMAIL){unauthorizedState.classList.add('hidden');adminDashboard.classList.remove('hidden');loadOrders();loadSubmissions('all');setTimeout(()=>{loadingState.classList.add('hidden');},500);}else{loadingState.classList.add('hidden');unauthorizedState.classList.remove('hidden');adminDashboard.classList.add('hidden');showError("Only admin accounts can access this dashboard");setTimeout(()=>{auth.signOut();},3000);}}else{loadingState.classList.add('hidden');unauthorizedState.classList.remove('hidden');adminDashboard.classList.add('hidden');}}function handleAdminLogin(){const btn=document.getElementById('adminLoginBtn');const originalBtnContent=btn.innerHTML;btn.disabled=true;btn.innerHTML='<span class="loading-spinner"></span> Signing in...';authError.classList.add('hidden');auth.signInWithPopup(provider).then((result)=>{const user=result.user;if(user.email===ADMIN_EMAIL){showToast("Admin login successful","success");}else{showToast("Only admin accounts can access this dashboard","error");auth.signOut();}}).catch((error)=>{console.error("Login error:",error);authError.textContent=error.message;authError.classList.remove('hidden');btn.innerHTML=originalBtnContent;btn.disabled=false;});}function handleLogout(){auth.signOut().then(()=>{showToast("Logged out successfully","success");}).catch((error)=>{console.error("Logout error:",error);showToast("Logout failed: "+error.message,"error");});}async function loadOrders(){try{const querySnapshot=await db.collection("orders").orderBy("timestamp","desc").get();allOrders=querySnapshot.docs.map(doc=>{const data=doc.data();const itemsWithTitles=data.items.map(item=>({...item,name:item.name||item.title||'Unnamed Product'}));return{id:doc.id,...data,items:itemsWithTitles,date:data.timestamp?.toDate()||new Date()};});totalOrders=allOrders.length;filteredOrders=[...allOrders];renderOrders(currentPage);setupPagination();}catch(error){console.error("Error loading orders:",error);showToast("Failed to load orders. Please refresh.","error");}}function filterOrders(){const searchTerm=searchOrders.value.toLowerCase();const statusFilterValue=statusFilter.value;filteredOrders=allOrders.filter(order=>{const matchesSearch=(order.id?.toLowerCase().includes(searchTerm))||(order.shippingAddress?.name?.toLowerCase().includes(searchTerm))||(order.email?.toLowerCase().includes(searchTerm));const matchesStatus=statusFilterValue?order.status===statusFilterValue:true;return matchesSearch&&matchesStatus;});totalOrders=filteredOrders.length;currentPage=1;renderOrders(currentPage);setupPagination();}function renderOrders(page){const startIndex=(page-1)*ordersPerPage;const endIndex=startIndex+ordersPerPage;const ordersToDisplay=filteredOrders.slice(startIndex,endIndex);ordersTableBody.innerHTML='';if(ordersToDisplay.length===0){ordersTableBody.innerHTML=`<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No orders found</td></tr>`;return;}ordersToDisplay.forEach(order=>{const orderRow=document.createElement('tr');orderRow.className='order-row hover:bg-gray-50 cursor-pointer';orderRow.dataset.orderId=order.id;const formattedDate=order.date.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});const total=order.items.reduce((sum,item)=>{const price=parseFloat(item.price.replace(/[^\d.]/g,''))||0;return sum+(price*(item.quantity||1));},0);orderRow.innerHTML=`<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.shippingAddress?.name||'N/A'}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formattedDate}</td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.items.length} item${order.items.length!==1?'s':''}</td><td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">â‚¹${total.toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap"><span class="status-badge status-${order.status}">${order.status}</span></td><td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700"><button class="text-blue-600 hover:text-blue-800 open-order-details" aria-label="View order details" title="View Details"><i class="fas fa-eye"></i></button></td>`;ordersTableBody.appendChild(orderRow);});document.querySelectorAll('.open-order-details').forEach(btn=>{btn.addEventListener('click',(e)=>{e.stopPropagation();const orderId=btn.closest('tr').dataset.orderId;showOrderDetails(orderId);});});document.querySelectorAll('.order-row').forEach(row=>{row.addEventListener('click',()=>{const orderId=row.dataset.orderId;showOrderDetails(orderId);});});}async function showOrderDetails(orderId){const order=filteredOrders.find(o=>o.id===orderId);if(!order)return;currentOrderId=orderId;document.getElementById('courierServiceSelect').value=order.courierService||"";if(order.trackingLink){document.getElementById('trackingLinkInput').value=order.trackingLink;}const formattedDate=order.date.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});const total=order.items.reduce((sum,item)=>{const price=parseFloat(item.price.replace(/[^\d.]/g,''))||0;return sum+(price*(item.quantity||1));},0);document.getElementById('modalOrderId').textContent=order.id;document.getElementById('modalOrderDate').textContent=formattedDate;document.getElementById('modalOrderStatus').textContent=order.status;document.getElementById('modalOrderStatus').className=`status-badge status-${order.status}`;document.getElementById('modalPaymentStatus').textContent=order.paymentId?'Paid':'Pending';document.getElementById('modalOrderTotal').textContent=`â‚¹${total.toFixed(2)}`;document.getElementById('modalCustomerName').textContent=order.shippingAddress?.name||'N/A';document.getElementById('modalCustomerEmail').textContent=order.email||'N/A';document.getElementById('modalCustomerPhone').textContent=order.shippingAddress?.phone||'N/A';const shippingAddress=order.shippingAddress||{};document.getElementById('modalShippingAddress').innerHTML=`<p>${shippingAddress.addressLine1||''}</p>${shippingAddress.addressLine2?`<p>${shippingAddress.addressLine2}</p>`:''}<p>${shippingAddress.city||''}, ${shippingAddress.state||''} ${shippingAddress.postalCode||''}</p><p>${shippingAddress.country||''}</p>`;const orderItemsContainer=document.getElementById('modalOrderItems');orderItemsContainer.innerHTML='';order.items.forEach(item=>{const itemElement=document.createElement('div');itemElement.className='flex items-start border-b pb-3 mb-3';const price=parseFloat(item.price.replace(/[^\d.]/g,''))||0;const itemTotal=price*(item.quantity||1);itemElement.innerHTML=`<img src="${item.image||'https://via.placeholder.com/60'}" alt="${item.name}" class="w-16 h-16 object-cover rounded mr-3"><div class="flex-1"><p class="font-medium">${item.name||'Unnamed Product'}</p><p class="text-sm text-gray-600">Size: ${item.size||'N/A'}</p><p class="text-sm text-gray-600">Qty: ${item.quantity||1}</p></div><div class="font-medium">â‚¹${itemTotal.toFixed(2)}</div>`;orderItemsContainer.appendChild(itemElement);});document.getElementById('statusUpdateSelect').value=order.status;if(order.status==='cancelled'||order.status==='refunded'||order.status==='delivered'){cancelOrderBtn.classList.add('hidden');}else{cancelOrderBtn.classList.remove('hidden');}orderDetailsModal.classList.remove('hidden');}async function updateOrderStatus(){if(!currentOrderId)return;const newStatus=document.getElementById('statusUpdateSelect').value;const orderRef=db.collection("orders").doc(currentOrderId);try{await orderRef.update({status:newStatus,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const orderIndex=allOrders.findIndex(o=>o.id===currentOrderId);if(orderIndex!==-1){allOrders[orderIndex].status=newStatus;allOrders[orderIndex].updatedAt=new Date();}const filteredIndex=filteredOrders.findIndex(o=>o.id===currentOrderId);if(filteredIndex!==-1){filteredOrders[filteredIndex].status=newStatus;filteredOrders[filteredIndex].updatedAt=new Date();}showToast("Order status updated successfully","success");renderOrders(currentPage);orderDetailsModal.classList.add('hidden');}catch(error){console.error("Error updating order status:",error);showToast("Failed to update order status: "+error.message,"error");}}async function cancelOrder(){if(!currentOrderId)return;if(!confirm("Are you sure you want to cancel this order?"))return;const orderRef=db.collection("orders").doc(currentOrderId);try{await orderRef.update({status:'cancelled',updatedAt:firebase.firestore.FieldValue.serverTimestamp()});const orderIndex=allOrders.findIndex(o=>o.id===currentOrderId);if(orderIndex!==-1){allOrders[orderIndex].status='cancelled';}const filteredIndex=filteredOrders.findIndex(o=>o.id===currentOrderId);if(filteredIndex!==-1){filteredOrders[filteredIndex].status='cancelled';}showToast("Order cancelled successfully","success");renderOrders(currentPage);orderDetailsModal.classList.add('hidden');}catch(error){console.error("Error cancelling order:",error);showToast("Failed to cancel order","error");}}async function deleteOrder(){if(!currentOrderId)return;if(!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const orderRef=db.collection("orders").doc(currentOrderId);try{await orderRef.delete();allOrders=allOrders.filter(o=>o.id!==currentOrderId);filteredOrders=filteredOrders.filter(o=>o.id!==currentOrderId);totalOrders=filteredOrders.length;if(currentPage>Math.ceil(totalOrders/ordersPerPage)){currentPage=Math.max(1,currentPage-1);}showToast("Order deleted successfully","success");renderOrders(currentPage);orderDetailsModal.classList.add('hidden');setupPagination();}catch(error){console.error("Error deleting order:",error);showToast("Failed to delete order","error");}}function setupPagination(){const totalPages=Math.ceil(totalOrders/ordersPerPage);pageNumbers.innerHTML='';const startOrder=(currentPage-1)*ordersPerPage+1;const endOrder=Math.min(currentPage*ordersPerPage,totalOrders);paginationInfo.innerHTML=`Showing <span class="font-medium">${startOrder}</span> to <span class="font-medium">${endOrder}</span> of <span class="font-medium">${totalOrders}</span> results`;for(let i=1;i<=totalPages;i++){const pageBtn=document.createElement('button');pageBtn.className=`relative inline-flex items-center px-4 py-2 border text-sm font-medium ${i===currentPage?'bg-black text-white border-black':'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`;pageBtn.textContent=i;pageBtn.addEventListener('click',()=>{currentPage=i;renderOrders(currentPage);setupPagination();});pageNumbers.appendChild(pageBtn);}prevPage.disabled=currentPage===1;prevPageMobile.disabled=currentPage===1;nextPage.disabled=currentPage===totalPages;nextPageMobile.disabled=currentPage===totalPages;}async function loadSubmissions(filter){try{loadingIndicator.classList.remove('hidden');noResults.classList.add('hidden');let query=db.collection('contactSubmissions').orderBy('timestamp','desc');if(filter!=='all')query=query.where('status','==',filter);const snapshot=await query.get();if(snapshot.empty){noResults.classList.remove('hidden');submissionsList.innerHTML='';}else{let html='';snapshot.forEach(doc=>{const data=doc.data();html+=`<article class="submission-card" data-status="${data.status||'new'}" data-name="${escapeHtml(data.name)}" data-email="${escapeHtml(data.email)}" data-message="${escapeHtml(data.message)}"><div class="submission-header"><div class="user-info"><h3>${escapeHtml(data.name||'No name')}</h3><p class="text-gray-600 text-sm">${escapeHtml(data.email||'No email')}</p></div><div class="meta-info"><span class="status-badge-contact status-${data.status||'new'}">${data.status||'new'}</span><time datetime="${(data.timestamp?.toDate()||new Date()).toISOString()}" class="text-gray-500 text-sm">${(data.timestamp?.toDate()||new Date()).toLocaleString()}</time></div></div><div class="submission-message">${escapeHtml(data.message||'No message')}</div><div class="submission-actions">${data.status!=='read'?`<button class="btn mark-read" data-id="${doc.id}" type="button" aria-label="Mark submission as read"><i class="fas fa-check"></i> Mark as Read</button>`:''}<button class="btn delete" data-id="${doc.id}" type="button" aria-label="Delete submission"><i class="fas fa-trash"></i> Delete</button></div></article>`;});submissionsList.innerHTML=html;}}catch(error){console.error("Error loading submissions:",error);showError("Failed to load submissions: "+error.message);}finally{loadingIndicator.classList.add('hidden');}}function filterSubmissions(){const term=searchInput.value.trim().toLowerCase();const submissions=submissionsList.querySelectorAll('.submission-card');let anyVisible=false;submissions.forEach(submission=>{const name=submission.getAttribute('data-name').toLowerCase();const email=submission.getAttribute('data-email').toLowerCase();const message=submission.getAttribute('data-message').toLowerCase();if(term===''||name.includes(term)||email.includes(term)||message.includes(term)){submission.classList.remove('hidden');anyVisible=true;}else{submission.classList.add('hidden');}});noResults.classList.toggle('hidden',anyVisible);}function escapeHtml(unsafe){if(!unsafe)return'';return unsafe.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}function showToast(message,type='success'){toast.textContent=message;toast.className=`hidden fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${type==='success'?'bg-green-500':'bg-red-500'}`;toast.classList.remove('hidden');setTimeout(()=>{toast.classList.add('hidden');},3000);}function showError(message){errorContainer.textContent=message;errorContainer.classList.remove('hidden');setTimeout(()=>{errorContainer.classList.add('hidden');},5000);}
