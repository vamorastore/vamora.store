<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - VAMORA.STORE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Unbounded', sans-serif;
            background-color: #f5f5f5;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
            min-width: 70px;
            text-align: center;
        }
        .status-placed { background-color: #EFF6FF; color: #1D4ED8; }
        .status-processed { background-color: #FEF3C7; color: #92400E; }
        .status-shipped { background-color: #EDE9FE; color: #5B21B6; }
        .status-delivered { background-color: #D1FAE5; color: #065F46; }
        .status-cancelled { background-color: #FEE2E2; color: #991B1B; }
        .status-refunded { background-color: #ECFDF5; color: #047857; }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .order-row:hover {
            background-color: #F9FAFB;
        }

        /* Contact form submission styles */
        .submission-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .submission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .submission-header {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .user-info h3 {
            margin: 0;
            font-size: 1.25rem;
        }
        .meta-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .status-badge-contact {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
            min-width: 60px;
            text-align: center;
        }
        .status-new { background: #dbeafe; color: #1e40af; }
        .status-read { background: #dcfce7; color: #166534; }
        .status-archived { background: #f3f4f6; color: #6b7280; }
        .submission-message {
            padding: 1rem 0;
            margin: 1rem 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            white-space: pre-line;
            font-size: 1rem;
            color: #374151;
        }
        .submission-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            user-select: none;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .mark-read { 
            background: #dcfce7; 
            color: #166534;
            border-color: #bbf7d0;
        }
        .mark-read:hover {
            background: #bbf7d0;
        }
        .delete { 
            background: #fee2e2; 
            color: #b91c1c;
            border-color: #fecaca;
        }
        .delete:hover {
            background: #fecaca;
        }
        .filter-btn {
            transition: all 0.2s;
            border-color: #d1d5db;
            background-color: white;
            color: #374151;
            user-select: none;
        }
        .filter-btn.active {
            background-color: black;
            color: white;
            border-color: black;
        }
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .hidden {
            display: none !important;
        }
        
        /* Auth modal styles */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .google-signin-btn {
            background-color: #4285F4;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s;
        }
        .google-signin-btn:hover {
            background-color: #3367D6;
            transform: translateY(-1px);
        }
        .google-signin-btn:active {
            transform: translateY(0);
        }
        .auth-error {
            color: #b91c1c;
            background-color: #fee2e2;
            padding: 0.75rem;
            border-radius: 0.25rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        /* Scrollbar for modal */
        #orderDetailsModal > div::-webkit-scrollbar {
            width: 8px;
        }
        #orderDetailsModal > div::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        
        /* Responsive improvements */
        @media (max-width: 640px) {
            .submission-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .meta-info {
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            .submission-actions {
                justify-content: flex-start;
            }
            table thead {
                display: none;
            }
            table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                background: white;
            }
            table tbody tr td {
                display: flex;
                justify-content: space-between;
                padding: 0.25rem 0.5rem;
                font-size: 0.9rem;
                border-bottom: 1px solid #e5e7eb;
            }
            table tbody tr td:last-child {
                border-bottom: none;
            }
            table tbody tr td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #6b7280;
                flex: 1;
                text-transform: uppercase;
                font-size: 0.75rem;
            }
            .order-row:hover {
                background-color: transparent;
            }
            #paginationInfo {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Loading State -->
    <div id="loadingState" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
            <p class="text-lg font-medium">Loading Dashboard...</p>
        </div>
    </div>

    <!-- Unauthorized State (hidden by default) -->
    <div id="unauthorizedState" class="hidden fixed inset-0 flex items-center justify-center bg-gray-50 z-40">
        <div class="text-center p-6 max-w-md">
            <h1 class="text-2xl font-bold mb-4">Admin Login Required</h1>
            <p class="mb-6">You need to sign in with an admin account to access this dashboard.</p>
            <button id="adminLoginBtn" class="google-signin-btn">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
            <div id="authError" class="auth-error hidden mt-4"></div>
        </div>
    </div>

    <!-- Admin Content (hidden by default) -->
    <div id="adminDashboard" class="hidden">
        <!-- Top Navbar -->
        <nav id="navBar" class="bg-black text-white p-4 shadow-md sticky top-0 z-30">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-xl font-bold tracking-wide">VAMORA.STORE</a>
                    <span class="text-sm bg-yellow-500 text-black px-2 py-1 rounded font-semibold tracking-wide">ADMIN</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="logoutBtn" class="text-sm hover:text-gray-300 flex items-center gap-1" aria-label="Logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Toggle Buttons -->
        <div class="container mx-auto px-4 py-6 flex justify-center space-x-4">
            <button id="showOrdersBtn" class="px-6 py-2 bg-black text-white rounded hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black" type="button" aria-pressed="true" aria-label="Show Orders Section">Orders</button>
            <button id="showSubmissionsBtn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-black" type="button" aria-pressed="false" aria-label="Show Contact Form Submissions Section">Submissions</button>
        </div>

        <div class="container mx-auto px-4 pb-12">
            <!-- Orders Management Section -->
            <section id="ordersSection" class="bg-white rounded-lg shadow p-6">
                <h1 class="text-2xl font-bold mb-6 tracking-wide">Orders Management</h1>

                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="relative flex-1">
                        <input type="text" id="searchOrders" placeholder="Search orders..." 
                               class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-black" aria-label="Search orders" />
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                    <select id="statusFilter" class="px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-black w-full sm:w-48" aria-label="Filter orders by status">
                        <option value="">All Statuses</option>
                        <option value="placed">Placed</option>
                        <option value="processed">Processed</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>

                <div class="overflow-x-auto rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200" role="table" aria-label="Orders Table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200" role="rowgroup">
                            <!-- Orders will be loaded dynamically -->
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" disabled aria-label="Previous page">
                            Previous
                        </button>
                        <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" disabled aria-label="Next page">
                            Next
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p id="paginationInfo" class="text-sm text-gray-700">
                                Loading...
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" disabled aria-label="Previous page">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div id="pageNumbers" class="flex">
                                    <!-- Page numbers will be added dynamically -->
                                </div>
                                <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" disabled aria-label="Next page">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contact Form Submissions Section -->
            <section id="contactSubmissionsSection" class="bg-white rounded-lg shadow p-6 hidden">
                <h1 class="text-3xl font-bold mb-8 tracking-wide">Contact Form Submissions</h1>

                <div class="flex flex-wrap gap-2 mb-6" id="filterButtonsContainer" role="group" aria-label="Filter submissions by status">
                    <button class="filter-btn active px-4 py-2 rounded border" data-filter="all" type="button" aria-pressed="true" aria-label="Show all submissions">All</button>
                    <button class="filter-btn px-4 py-2 rounded border" data-filter="new" type="button" aria-pressed="false" aria-label="Show new submissions">New</button>
                    <button class="filter-btn px-4 py-2 rounded border" data-filter="read" type="button" aria-pressed="false" aria-label="Show read submissions">Read</button>
                    <button class="filter-btn px-4 py-2 rounded border" data-filter="archived" type="button" aria-pressed="false" aria-label="Show archived submissions">Archived</button>
                </div>

                <div class="mb-6">
                    <input type="text" id="searchInput" placeholder="Search by name, email or message..." 
                           class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Search submissions" />
                </div>

                <div id="errorContainer" class="hidden error-message" role="alert"></div>

                <div id="submissionsList" class="mb-6" aria-live="polite" aria-relevant="additions removals">
                    <!-- Submissions will be loaded dynamically -->
                    <div class="text-center py-8 text-gray-500">Loading submissions...</div>
                </div>

                <div id="loadingIndicator" class="text-center py-8 hidden" aria-live="polite" aria-atomic="true">
                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                    <p class="mt-2">Loading submissions...</p>
                </div>

                <div id="noResults" class="hidden text-center py-8" aria-live="polite" aria-atomic="true">
                    <i class="fas fa-inbox text-3xl text-gray-400"></i>
                    <p class="mt-2 text-gray-500">No submissions found</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="orderDetailsTitle" aria-describedby="orderDetailsDesc">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto focus:outline-none" tabindex="-1">
            <div class="flex justify-between items-center border-b p-4 sticky top-0 bg-white z-10">
                <h3 id="orderDetailsTitle" class="text-lg font-bold tracking-wide">Order Details</h3>
                <button id="closeOrderDetails" class="text-gray-500 hover:text-gray-700" aria-label="Close order details modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-6" id="orderDetailsDesc">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold mb-2 tracking-wide">Order Information</h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            <p><span class="font-semibold text-gray-600">Order ID:</span> <span id="modalOrderId" class="font-medium"></span></p>
                            <p><span class="font-semibold text-gray-600">Date:</span> <span id="modalOrderDate" class="font-medium"></span></p>
                            <p><span class="font-semibold text-gray-600">Status:</span> <span id="modalOrderStatus" class="status-badge"></span></p>
                            <p><span class="font-semibold text-gray-600">Payment:</span> <span id="modalPaymentStatus" class="font-medium"></span></p>
                            <p><span class="font-semibold text-gray-600">Total:</span> <span id="modalOrderTotal" class="font-medium"></span></p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold mb-2 tracking-wide">Customer Information</h4>
                        <div class="space-y-2 text-gray-700 text-sm">
                            <p id="modalCustomerName" class="font-medium"></p>
                            <p id="modalCustomerEmail"></p>
                            <p id="modalCustomerPhone"></p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold mb-2 tracking-wide">Shipping Address</h4>
                    <div id="modalShippingAddress" class="bg-gray-50 p-3 rounded text-gray-700 text-sm"></div>
                </div>
                
                <div>
                    <h4 class="font-bold mb-2 tracking-wide">Items</h4>
                    <div id="modalOrderItems" class="space-y-3 text-gray-700 text-sm"></div>
                </div>
                
                <div class="border-t pt-4">
                    <h4 class="font-bold mb-2 tracking-wide">Update Status</h4>
                    <div class="flex flex-wrap items-center gap-3">
                        <select id="statusUpdateSelect" class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-black" aria-label="Select new order status">
                            <option value="placed">Placed</option>
                            <option value="processed">Processed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="refunded">Refunded</option>
                        </select>
                        <button id="updateStatusBtn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black" aria-label="Update order status">
                            Update Status
                        </button>
                        <button id="cancelOrderBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-700 hidden" aria-label="Cancel order">
                            Cancel Order
                        </button>
                        <button id="deleteOrderBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-700" aria-label="Delete order">
                            Delete Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white bg-green-500" role="alert" aria-live="assertive" aria-atomic="true"></div>

    <!-- Firebase and other scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
       <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBkMUmD27GU34yIPQAj7KUErt9muB0MdLk",
        authDomain: "vamora-co-in.firebaseapp.com",
        projectId: "vamora-co-in",
        storageBucket: "vamora-co-in.appspot.com",
        messagingSenderId: "613048727757",
        appId: "1:613048727757:web:d0c73e84fa7d93a5c21184",
        measurementId: "G-8R6TDRQGS6"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // Only allow specific admin email
    const ADMIN_EMAIL = 'vamora.co.in@gmail.com';
    
    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const unauthorizedState = document.getElementById('unauthorizedState');
    const adminDashboard = document.getElementById('adminDashboard');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authError = document.getElementById('authError');
    const showOrdersBtn = document.getElementById('showOrdersBtn');
    const showSubmissionsBtn = document.getElementById('showSubmissionsBtn');
    const ordersSection = document.getElementById('ordersSection');
    const submissionsSection = document.getElementById('contactSubmissionsSection');
    const toast = document.getElementById('toast');
    
    // Orders Management Elements
    const ordersTableBody = document.getElementById('ordersTableBody');
    const searchOrders = document.getElementById('searchOrders');
    const statusFilter = document.getElementById('statusFilter');
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    
    // Submissions Management Elements
    const submissionsList = document.getElementById('submissionsList');
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const errorContainer = document.getElementById('errorContainer');
    
    // Pagination Elements
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const prevPageMobile = document.getElementById('prevPageMobile');
    const nextPageMobile = document.getElementById('nextPageMobile');
    const pageNumbers = document.getElementById('pageNumbers');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Order Details Modal Elements
    const closeOrderDetailsBtn = document.getElementById('closeOrderDetails');
    const updateStatusBtn = document.getElementById('updateStatusBtn');
    const cancelOrderBtn = document.getElementById('cancelOrderBtn');
    const deleteOrderBtn = document.getElementById('deleteOrderBtn');
    
    // Global Variables
    let currentPage = 1;
    const ordersPerPage = 10;
    let totalOrders = 0;
    let allOrders = [];
    let filteredOrders = [];
    let currentOrderId = null;
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        setupEventListeners();
        
        // Check auth state
        auth.onAuthStateChanged(handleAuthStateChange);
    });
    
    // Set up all event listeners
    function setupEventListeners() {
        // Auth related
        if (adminLoginBtn) adminLoginBtn.addEventListener('click', handleAdminLogin);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        
        // Section toggles - FIXED: Corrected event listeners for section switching
        if (showOrdersBtn) showOrdersBtn.addEventListener('click', showOrdersSection);
        if (showSubmissionsBtn) showSubmissionsBtn.addEventListener('click', showSubmissionsSection);
        
        // Orders management
        if (searchOrders) searchOrders.addEventListener('input', filterOrders);
        if (statusFilter) statusFilter.addEventListener('change', filterOrders);
        
        // Order details modal
        if (closeOrderDetailsBtn) closeOrderDetailsBtn.addEventListener('click', () => orderDetailsModal.classList.add('hidden'));
        if (updateStatusBtn) updateStatusBtn.addEventListener('click', updateOrderStatus);
        if (cancelOrderBtn) cancelOrderBtn.addEventListener('click', cancelOrder);
        if (deleteOrderBtn) deleteOrderBtn.addEventListener('click', deleteOrder);
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === orderDetailsModal) {
                orderDetailsModal.classList.add('hidden');
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !orderDetailsModal.classList.contains('hidden')) {
                orderDetailsModal.classList.add('hidden');
            }
        });
        
        // Submissions management
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadSubmissions(btn.dataset.filter);
            });
        });
        
        if (searchInput) searchInput.addEventListener('input', filterSubmissions);
        
        // Event delegation for submission actions
        if (submissionsList) {
            submissionsList.addEventListener('click', async (e) => {
                const target = e.target.closest('.mark-read, .delete');
                if (!target) return;
                
                const id = target.dataset.id;
                const card = target.closest('.submission-card');
                
                try {
                    // Add click effect
                    target.style.transform = 'scale(0.95)';
                    setTimeout(() => { target.style.transform = ''; }, 200);
                    
                    if (target.classList.contains('mark-read')) {
                        await db.collection('contactSubmissions').doc(id).update({ status: 'read' });
                        card.querySelector('.status-badge-contact').className = 'status-badge-contact status-read';
                        card.querySelector('.status-badge-contact').textContent = 'read';
                        target.remove();
                    } 
                    else if (target.classList.contains('delete')) {
                        if (confirm('Are you sure you want to delete this submission?')) {
                            await db.collection('contactSubmissions').doc(id).delete();
                            card.style.opacity = '0';
                            setTimeout(() => card.remove(), 300);
                        }
                    }
                    
                    // Update the active filter view
                    const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                    if (activeFilter !== 'all') {
                        if (target.classList.contains('delete')) {
                            // If deleted, no need to check filter
                        } else if (activeFilter !== 'read' && target.classList.contains('mark-read')) {
                            card.style.display = 'none';
                        }
                    }
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        showError("You don't have permission to perform this action");
                    } else {
                        showError(`Operation failed: ${error.message}`);
                    }
                }
            });
        }
    }
    
    // Handle authentication state changes
    function handleAuthStateChange(user) {
        if (user) {
            // User is signed in - verify admin status
            if (user.email === ADMIN_EMAIL) {
                // User is admin - show dashboard
                unauthorizedState.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                
                // Load data
                loadOrders();
                loadSubmissions('all');
                
                // Hide loading state
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                }, 500);
            } else {
                // User is not admin
                loadingState.classList.add('hidden');
                unauthorizedState.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
                showError("Only admin accounts can access this dashboard");
                
                // Sign out non-admin users
                setTimeout(() => {
                    auth.signOut();
                }, 3000);
            }
        } else {
            // No user is signed in
            loadingState.classList.add('hidden');
            unauthorizedState.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
        }
    }
    
    // Handle admin login with Google
    function handleAdminLogin() {
        const btn = document.getElementById('adminLoginBtn');
        const originalBtnContent = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Signing in...';
        authError.classList.add('hidden');
        
        auth.signInWithPopup(provider)
            .then((result) => {
                const user = result.user;
                if (user.email === ADMIN_EMAIL) {
                    showToast("Admin login successful", "success");
                } else {
                    showToast("Only admin accounts can access this dashboard", "error");
                    auth.signOut();
                }
            })
            .catch((error) => {
                console.error("Login error:", error);
                authError.textContent = error.message;
                authError.classList.remove('hidden');
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            });
    }
    
    // Handle logout
    function handleLogout() {
        auth.signOut()
            .then(() => {
                showToast("Logged out successfully", "success");
            })
            .catch((error) => {
                console.error("Logout error:", error);
                showToast("Logout failed: " + error.message, "error");
            });
    }
    
    // Toggle between orders and submissions sections - FIXED: Corrected section switching logic
    function showOrdersSection() {
        ordersSection.classList.remove('hidden');
        submissionsSection.classList.add('hidden');
        showOrdersBtn.classList.remove('bg-gray-300', 'text-gray-800');
        showOrdersBtn.classList.add('bg-black', 'text-white');
        showSubmissionsBtn.classList.remove('bg-black', 'text-white');
        showSubmissionsBtn.classList.add('bg-gray-300', 'text-gray-800');
    }
    
    function showSubmissionsSection() {
        submissionsSection.classList.remove('hidden');
        ordersSection.classList.add('hidden');
        showSubmissionsBtn.classList.remove('bg-gray-300', 'text-gray-800');
        showSubmissionsBtn.classList.add('bg-black', 'text-white');
        showOrdersBtn.classList.remove('bg-black', 'text-white');
        showOrdersBtn.classList.add('bg-gray-300', 'text-gray-800');
    }
    
    // Load orders from Firestore - FIXED: Added proper product title handling
    async function loadOrders() {
        try {
            const querySnapshot = await db.collection("orders")
                .orderBy("timestamp", "desc")
                .get();
            
            allOrders = querySnapshot.docs.map(doc => {
                const data = doc.data();
                // Ensure items have proper names/titles
                const itemsWithTitles = data.items.map(item => ({
                    ...item,
                    name: item.name || item.title || 'Unnamed Product' // Fallback for missing names
                }));
                
                return {
                    id: doc.id,
                    ...data,
                    items: itemsWithTitles, // Use the items with ensured names
                    date: data.timestamp?.toDate() || new Date()
                };
            });
            
            totalOrders = allOrders.length;
            filteredOrders = [...allOrders];
            
            renderOrders(currentPage);
            setupPagination();
        } catch (error) {
            console.error("Error loading orders:", error);
            showToast("Failed to load orders. Please refresh.", "error");
        }
    }
    
    // Filter orders based on search and status
    function filterOrders() {
        const searchTerm = searchOrders.value.toLowerCase();
        const statusFilterValue = statusFilter.value;
        
        filteredOrders = allOrders.filter(order => {
            // Search filter
            const matchesSearch = 
                (order.id?.toLowerCase().includes(searchTerm)) ||
                (order.shippingAddress?.name?.toLowerCase().includes(searchTerm)) ||
                (order.email?.toLowerCase().includes(searchTerm));
            
            // Status filter
            const matchesStatus = statusFilterValue ? 
                order.status === statusFilterValue : true;
            
            return matchesSearch && matchesStatus;
        });
        
        totalOrders = filteredOrders.length;
        currentPage = 1; // Reset to first page when filtering
        renderOrders(currentPage);
        setupPagination();
    }
    
    // Render orders for the current page
    function renderOrders(page) {
        const startIndex = (page - 1) * ordersPerPage;
        const endIndex = startIndex + ordersPerPage;
        const ordersToDisplay = filteredOrders.slice(startIndex, endIndex);
        
        ordersTableBody.innerHTML = '';
        
        if (ordersToDisplay.length === 0) {
            ordersTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        No orders found
                    </td>
                </tr>
            `;
            return;
        }
        
        ordersToDisplay.forEach(order => {
            const orderRow = document.createElement('tr');
            orderRow.className = 'order-row hover:bg-gray-50 cursor-pointer';
            orderRow.dataset.orderId = order.id;
            
            // Format date
            const formattedDate = order.date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Calculate total
            const total = order.items.reduce((sum, item) => {
                const price = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
                return sum + (price * (item.quantity || 1));
            }, 0);
            
            orderRow.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.shippingAddress?.name || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formattedDate}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.items.length} item${order.items.length !== 1 ? 's' : ''}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-900">$${total.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="status-badge status-${order.status}">${order.status}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                    <button class="text-blue-600 hover:text-blue-800 open-order-details" aria-label="View order details" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            ordersTableBody.appendChild(orderRow);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.open-order-details').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering the row click
                const orderId = btn.closest('tr').dataset.orderId;
                showOrderDetails(orderId);
            });
        });
        
        // Add click event to entire row
        document.querySelectorAll('.order-row').forEach(row => {
            row.addEventListener('click', () => {
                const orderId = row.dataset.orderId;
                showOrderDetails(orderId);
            });
        });
    }
    
    // Show order details modal
    async function showOrderDetails(orderId) {
        const order = filteredOrders.find(o => o.id === orderId);
        if (!order) return;
        
        currentOrderId = orderId;
        
        // Format date
        const formattedDate = order.date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Calculate total
        const total = order.items.reduce((sum, item) => {
            const price = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
            return sum + (price * (item.quantity || 1));
        }, 0);
        
        // Set order information
        document.getElementById('modalOrderId').textContent = order.id;
        document.getElementById('modalOrderDate').textContent = formattedDate;
        document.getElementById('modalOrderStatus').textContent = order.status;
        document.getElementById('modalOrderStatus').className = `status-badge status-${order.status}`;
        document.getElementById('modalPaymentStatus').textContent = order.paymentId ? 'Paid' : 'Pending';
        document.getElementById('modalOrderTotal').textContent = `$${total.toFixed(2)}`;
        
        // Set customer information
        document.getElementById('modalCustomerName').textContent = order.shippingAddress?.name || 'N/A';
        document.getElementById('modalCustomerEmail').textContent = order.email || 'N/A';
        document.getElementById('modalCustomerPhone').textContent = order.shippingAddress?.phone || 'N/A';
        
        // Set shipping address
        const shippingAddress = order.shippingAddress || {};
        document.getElementById('modalShippingAddress').innerHTML = `
            <p>${shippingAddress.addressLine1 || ''}</p>
            ${shippingAddress.addressLine2 ? `<p>${shippingAddress.addressLine2}</p>` : ''}
            <p>${shippingAddress.city || ''}, ${shippingAddress.state || ''} ${shippingAddress.postalCode || ''}</p>
            <p>${shippingAddress.country || ''}</p>
        `;
        
        // Set order items - FIXED: Ensure product name is displayed
        const orderItemsContainer = document.getElementById('modalOrderItems');
        orderItemsContainer.innerHTML = '';
        
        order.items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'flex items-start border-b pb-3 mb-3';
            
            const price = parseFloat(item.price.replace(/[^\d.]/g, '')) || 0;
            const itemTotal = price * (item.quantity || 1);
            
            itemElement.innerHTML = `
                <img src="${item.image || 'https://via.placeholder.com/60'}" 
                     alt="${item.name}" 
                     class="w-16 h-16 object-cover rounded mr-3">
                <div class="flex-1">
                    <p class="font-medium">${item.name || 'Unnamed Product'}</p>
                    <p class="text-sm text-gray-600">Size: ${item.size || 'N/A'}</p>
                    <p class="text-sm text-gray-600">Qty: ${item.quantity || 1}</p>
                </div>
                <div class="font-medium">$${itemTotal.toFixed(2)}</div>
            `;
            
            orderItemsContainer.appendChild(itemElement);
        });
        
        // Set status update select
        document.getElementById('statusUpdateSelect').value = order.status;
        
        // Show/hide cancel button based on current status
        if (order.status === 'cancelled' || order.status === 'refunded' || order.status === 'delivered') {
            cancelOrderBtn.classList.add('hidden');
        } else {
            cancelOrderBtn.classList.remove('hidden');
        }
        
        // Show modal
        orderDetailsModal.classList.remove('hidden');
    }
    
    // Update order status
    async function updateOrderStatus() {
        if (!currentOrderId) return;
        
        const newStatus = document.getElementById('statusUpdateSelect').value;
        const orderRef = db.collection("orders").doc(currentOrderId);
        
        try {
            await orderRef.update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local data
            const orderIndex = allOrders.findIndex(o => o.id === currentOrderId);
            if (orderIndex !== -1) {
                allOrders[orderIndex].status = newStatus;
                allOrders[orderIndex].updatedAt = new Date();
            }
            
            // Update filtered orders if needed
            const filteredIndex = filteredOrders.findIndex(o => o.id === currentOrderId);
            if (filteredIndex !== -1) {
                filteredOrders[filteredIndex].status = newStatus;
                filteredOrders[filteredIndex].updatedAt = new Date();
            }
            
            showToast("Order status updated successfully", "success");
            renderOrders(currentPage);
            orderDetailsModal.classList.add('hidden');
        } catch (error) {
            console.error("Error updating order status:", error);
            showToast("Failed to update order status: " + error.message, "error");
        }
    }
    
    // Cancel order
    async function cancelOrder() {
        if (!currentOrderId) return;
        if (!confirm("Are you sure you want to cancel this order?")) return;
        
        const orderRef = db.collection("orders").doc(currentOrderId);
        
        try {
            await orderRef.update({
                status: 'cancelled',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local data
            const orderIndex = allOrders.findIndex(o => o.id === currentOrderId);
            if (orderIndex !== -1) {
                allOrders[orderIndex].status = 'cancelled';
            }
            
            // Update filtered orders if needed
            const filteredIndex = filteredOrders.findIndex(o => o.id === currentOrderId);
            if (filteredIndex !== -1) {
                filteredOrders[filteredIndex].status = 'cancelled';
            }
            
            showToast("Order cancelled successfully", "success");
            renderOrders(currentPage);
            orderDetailsModal.classList.add('hidden');
        } catch (error) {
            console.error("Error cancelling order:", error);
            showToast("Failed to cancel order", "error");
        }
    }
    
    // Delete order
    async function deleteOrder() {
        if (!currentOrderId) return;
        if (!confirm("Are you sure you want to delete this order? This action cannot be undone.")) return;
        
        const orderRef = db.collection("orders").doc(currentOrderId);
        
        try {
            await orderRef.delete();
            
            // Update local data
            allOrders = allOrders.filter(o => o.id !== currentOrderId);
            filteredOrders = filteredOrders.filter(o => o.id !== currentOrderId);
            totalOrders = filteredOrders.length;
            
            // Adjust current page if needed
            if (currentPage > Math.ceil(totalOrders / ordersPerPage)) {
                currentPage = Math.max(1, currentPage - 1);
            }
            
            showToast("Order deleted successfully", "success");
            renderOrders(currentPage);
            orderDetailsModal.classList.add('hidden');
            setupPagination();
        } catch (error) {
            console.error("Error deleting order:", error);
            showToast("Failed to delete order", "error");
        }
    }
    
    // Setup pagination controls
    function setupPagination() {
        const totalPages = Math.ceil(totalOrders / ordersPerPage);
        pageNumbers.innerHTML = '';
        
        // Update pagination info
        const startOrder = (currentPage - 1) * ordersPerPage + 1;
        const endOrder = Math.min(currentPage * ordersPerPage, totalOrders);
        paginationInfo.innerHTML = `
            Showing <span class="font-medium">${startOrder}</span> to 
            <span class="font-medium">${endOrder}</span> of 
            <span class="font-medium">${totalOrders}</span> results
        `;
        
        // Add page numbers
        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                i === currentPage 
                    ? 'bg-black text-white border-black' 
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            pageBtn.textContent = i;
            pageBtn.addEventListener('click', () => {
                currentPage = i;
                renderOrders(currentPage);
                setupPagination();
            });
            pageNumbers.appendChild(pageBtn);
        }
        
        // Previous button
        prevPage.disabled = currentPage === 1;
        prevPageMobile.disabled = currentPage === 1;
        
        // Next button
        nextPage.disabled = currentPage === totalPages;
        nextPageMobile.disabled = currentPage === totalPages;
    }
    
    // Load submissions from Firestore
    async function loadSubmissions(filter) {
        try {
            loadingIndicator.classList.remove('hidden');
            noResults.classList.add('hidden');
            
            let query = db.collection('contactSubmissions').orderBy('timestamp', 'desc');
            if (filter !== 'all') query = query.where('status', '==', filter);
            
            const snapshot = await query.get();
            
            if (snapshot.empty) {
                noResults.classList.remove('hidden');
                submissionsList.innerHTML = '';
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <article class="submission-card" data-status="${data.status || 'new'}" data-name="${escapeHtml(data.name)}" data-email="${escapeHtml(data.email)}" data-message="${escapeHtml(data.message)}">
                            <div class="submission-header">
                                <div class="user-info">
                                    <h3>${escapeHtml(data.name || 'No name')}</h3>
                                    <p class="text-gray-600 text-sm">${escapeHtml(data.email || 'No email')}</p>
                                </div>
                                <div class="meta-info">
                                    <span class="status-badge-contact status-${data.status || 'new'}">${data.status || 'new'}</span>
                                    <time datetime="${(data.timestamp?.toDate() || new Date()).toISOString()}" class="text-gray-500 text-sm">
                                        ${(data.timestamp?.toDate() || new Date()).toLocaleString()}
                                    </time>
                                </div>
                            </div>
                            <div class="submission-message">
                                ${escapeHtml(data.message || 'No message')}
                            </div>
                            <div class="submission-actions">
                                ${data.status !== 'read' ? `
                                    <button class="btn mark-read" data-id="${doc.id}" type="button" aria-label="Mark submission as read">
                                        <i class="fas fa-check"></i> Mark as Read
                                    </button>
                                ` : ''}
                                <button class="btn delete" data-id="${doc.id}" type="button" aria-label="Delete submission">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </article>
                    `;
                });
                submissionsList.innerHTML = html;
            }
        } catch (error) {
            console.error("Error loading submissions:", error);
            showError("Failed to load submissions: " + error.message);
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }
    
    // Filter submissions based on search input
    function filterSubmissions() {
        const term = searchInput.value.trim().toLowerCase();
        const submissions = submissionsList.querySelectorAll('.submission-card');
        let anyVisible = false;
        
        submissions.forEach(submission => {
            const name = submission.getAttribute('data-name').toLowerCase();
            const email = submission.getAttribute('data-email').toLowerCase();
            const message = submission.getAttribute('data-message').toLowerCase();
            
            if (term === '' || name.includes(term) || email.includes(term) || message.includes(term)) {
                submission.classList.remove('hidden');
                anyVisible = true;
            } else {
                submission.classList.add('hidden');
            }
        });
        
        noResults.classList.toggle('hidden', anyVisible);
    }
    
    // Helper functions
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `hidden fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
    
    function showError(message) {
        errorContainer.textContent = message;
        errorContainer.classList.remove('hidden');
        
        setTimeout(() => {
            errorContainer.classList.add('hidden');
        }, 5000);
    }
    </script>
</body>
</html>
