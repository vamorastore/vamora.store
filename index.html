<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Unbounded', sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        /* Add this to your existing styles */
#googleSignInBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

#googleSignInBtn i {
    font-size: 18px;
}

/* Loading spinner for sign-in */
.signin-loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
        
        .submission-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        
        .submission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .status-new {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-read {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-archived {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .filter-btn {
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background-color: black;
            color: white;
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="bg-gray-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-xl font-bold">Admin Dashboard</div>
            <div>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto py-8">
        <div id="errorContainer" class="hidden"></div>
        
        <h1 class="text-3xl font-bold mb-8">Contact Form Submissions</h1>
        
        <div class="flex space-x-2 mb-6">
            <button class="filter-btn px-4 py-2 rounded border active" data-filter="all">All</button>
            <button class="filter-btn px-4 py-2 rounded border" data-filter="new">New</button>
            <button class="filter-btn px-4 py-2 rounded border" data-filter="read">Read</button>
            <button class="filter-btn px-4 py-2 rounded border" data-filter="archived">Archived</button>
        </div>
        
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="Search by name, email or message..." 
                   class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div id="submissionsList"></div>
        
        <div id="loadingIndicator" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl"></i>
            <p class="mt-2">Loading submissions...</p>
        </div>
        
        <div id="noResults" class="hidden text-center py-8">
            <i class="fas fa-inbox text-3xl text-gray-400"></i>
            <p class="mt-2 text-gray-500">No submissions found</p>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBkMUmD27GU34yIPQAj7KUErt9muB0MdLk",
            authDomain: "vamora-co-in.firebaseapp.com",
            projectId: "vamora-co-in",
            storageBucket: "vamora-co-in.appspot.com",
            messagingSenderId: "613048727757",
            appId: "1:613048727757:web:d0c73e84fa7d93a5c21184",
            measurementId: "G-8R6TDRQGS6"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            showError("Firebase initialization failed: " + error.message);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase loaded properly
            if (!firebase.apps.length) {
                showError("Firebase failed to initialize. Please refresh the page.");
                return;
            }
            
            // Authentication state listener

auth.onAuthStateChanged(async user => {
    if (!user) {
        // User not logged in - show Google Sign-In
        showGoogleSignIn();
    } else {
        // Check if user signed in with Google
         if (user.providerData.some(provider => provider.providerId === 'google.com')) {
            // Special case for vamora.co.in@gmail.com
            if (user.email === 'vamora.co.in@gmail.com') {
                loadSubmissions('all');
                return;
            } else {
                showError("You don't have admin privileges");
                setTimeout(() => auth.signOut(), 3000);
            }
        } else {
            // Not a Google user - force sign out and show Google Sign-In
            auth.signOut();
            showGoogleSignIn();
        }
    }
});

function showGoogleSignIn() {
    // Create a modal for Google Sign-In
    const authModal = document.createElement('div');
    authModal.style.position = 'fixed';
    authModal.style.top = '0';
    authModal.style.left = '0';
    authModal.style.width = '100%';
    authModal.style.height = '100%';
    authModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
    authModal.style.display = 'flex';
    authModal.style.justifyContent = 'center';
    authModal.style.alignItems = 'center';
    authModal.style.zIndex = '1000';
    
    authModal.innerHTML = `
        <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center;">
            <h2>Admin Login Required</h2>
            <p>Please sign in with your Google account</p>
            <button id="googleSignInBtn" style="background: #4285F4; color: white; 
                    border: none; padding: 10px 20px; border-radius: 4px; 
                    font-size: 16px; cursor: pointer;">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
        </div>
    `;
    
    document.body.appendChild(authModal);
    
    document.getElementById('googleSignInBtn').addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .catch(error => {
                showError("Sign in failed: " + error.message);
            });
    });
}            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                });
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadSubmissions(this.dataset.filter);
                });
            });
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                filterSubmissions(this.value.toLowerCase());
            });
        });
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            errorContainer.classList.remove('hidden');
        }
        
// Replace your checkAdminStatus function with this:
async function checkAdminStatus(uid) {
    try {
        const user = auth.currentUser;
        
        // First check if it's the specific email
        if (user.email === 'vamora.co.in@gmail.com') {
            return true;
        }
        
        // Fallback to admin collection check
        const doc = await db.collection('admins').doc(uid).get();
        return doc.exists;
        
    } catch (error) {
        console.error("Admin check error:", error);
        return false;
    }
}// In the same admin dashboard page, replace the existing loadSubmissions function:

async function loadSubmissions(filter) {
    try {
        document.getElementById('submissionsList').innerHTML = '';
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('noResults').classList.add('hidden');
        
        let query = db.collection('contactSubmissions').orderBy('timestamp', 'desc');
        
        if (filter !== 'all') {
            query = query.where('status', '==', filter);
        }
        
        const snapshot = await query.get();
        
        document.getElementById('loadingIndicator').classList.add('hidden');
        
        if (snapshot.empty) {
            document.getElementById('noResults').classList.remove('hidden');
            return;
        }
        
        let submissionsHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            submissionsHTML += createSubmissionCard(doc.id, data);
        });
        
        document.getElementById('submissionsList').innerHTML = submissionsHTML;
        setupEventListeners();
    } catch (error) {
        console.error("Error loading submissions:", error);
        document.getElementById('loadingIndicator').classList.add('hidden');
        showError("Failed to load submissions: " + error.message);
    }
}        
        function filterSubmissions(searchTerm) {
            const cards = document.querySelectorAll('.submission-card');
            let hasResults = false;
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.classList.remove('hidden');
                    hasResults = true;
                } else {
                    card.classList.add('hidden');
                }
            });
            
            document.getElementById('noResults').classList.toggle('hidden', hasResults);
        }
        
        function createSubmissionCard(id, data) {
            const date = data.timestamp?.toDate() || new Date();
            const formattedDate = date.toLocaleString();
            
            return `
                <div class="submission-card" data-id="${id}" data-status="${data.status}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="text-xl font-bold">${escapeHtml(data.name || 'No name')}</h3>
                            <p class="text-blue-600">${escapeHtml(data.email || 'No email')}</p>
                        </div>
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 rounded-full text-sm ${getStatusClass(data.status)}">
                                ${data.status || 'new'}
                            </span>
                            <span class="text-gray-500 text-sm">${formattedDate}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 whitespace-pre-line">${escapeHtml(data.message || 'No message')}</p>
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        ${data.status !== 'read' ? `
                            <button class="status-btn px-3 py-1 bg-green-100 text-green-800 rounded" 
                                    data-id="${id}" data-status="read">
                                <i class="fas fa-check mr-1"></i> Mark as Read
                            </button>
                        ` : ''}
                        
                        ${data.status !== 'archived' ? `
                            <button class="status-btn px-3 py-1 bg-gray-100 text-gray-800 rounded" 
                                    data-id="${id}" data-status="archived">
                                <i class="fas fa-archive mr-1"></i> Archive
                            </button>
                        ` : ''}
                        
                        <button class="delete-btn px-3 py-1 bg-red-100 text-red-800 rounded" 
                                data-id="${id}">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    updateSubmissionStatus(this.dataset.id, this.dataset.status);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this submission?')) {
                        deleteSubmission(this.dataset.id);
                    }
                });
            });
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'status-new';
                case 'read': return 'status-read';
                case 'archived': return 'status-archived';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function updateSubmissionStatus(id, status) {
            db.collection('contactSubmissions').doc(id).update({ status })
                .catch(error => showError("Update failed: " + error.message));
        }
        
        function deleteSubmission(id) {
            db.collection('contactSubmissions').doc(id).delete()
                .catch(error => showError("Delete failed: " + error.message));
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
